name: Deploy homelab infrastructure
run-name: ${{ gitea.actor }} is deploying K3s infrastructure with OpenTofu ðŸš€

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  deploy-k3s-infra:
    runs-on: n100
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify OpenTofu installation
        run: |
          if ! command -v tofu &> /dev/null; then
            echo "âŒ OpenTofu is not installed"
            exit 1
          fi
          echo "âœ… OpenTofu version: $(tofu version)"

      - name: Initialize OpenTofu
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Initializing OpenTofu for ${{ github.event.inputs.environment }} environment..."
          tofu init

      - name: Validate OpenTofu configuration
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Validating configuration..."
          tofu validate

      - name: Plan infrastructure changes
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ“‹ Planning infrastructure changes..."
          tofu plan -var-file=terraform.tfvars

      - name: Apply infrastructure changes
        if: github.event.inputs.action == 'apply'
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Applying infrastructure changes..."
          tofu apply -var-file=terraform.tfvars -auto-approve

      - name: Destroy infrastructure
        if: github.event.inputs.action == 'destroy'
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "âš ï¸  Destroying infrastructure..."
          tofu destroy -var-file=terraform.tfvars -auto-approve

      - name: Show deployment status
        if: github.event.inputs.action == 'apply'
        working-directory: infra/tofu/proxmox-k3s/envs/${{ github.event.inputs.environment }}
        run: |
          echo "ðŸŽ‰ Deployment Summary:"
          tofu output deployment_status 2>/dev/null || echo "Deployment completed"
