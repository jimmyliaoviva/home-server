name: Provision gitea action Runner

on:
  workflow_dispatch:  # Allow manual triggering
    inputs:
      container_name:
        description: 'Container name for the runner'
        required: true
        type: string
  workflow_call:  # Allow being called by other workflows
    inputs:
      container_name:
        description: 'Container name for the runner'
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      GITHUB_KEY:
        required: true
      RUNNER_TOKEN:
        required: true
      TOKEN:
        required: true

jobs:
  Provision:
    name: Start runner
    runs-on: n100
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}
            ${{ secrets.GITHUB_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H 192.168.68.182 >> ~/.ssh/known_hosts

      - name: provision new runner
        shell: bash
        run: |
          ssh jimmy@192.168.68.182 << 'EOF'
          set -e

          echo "ðŸš€ Provisioning Gitea Actions Runner on portainer3..."

          # Login to Gitea registry first
          echo "ðŸ” Logging into Gitea registry..."
          echo "${{ secrets.TOKEN }}" | docker login gitea.jimmylab.duckdns.org -u jimmy --password-stdin

          # Pull latest runner image
          echo "ðŸ“¦ Pulling latest runner image..."
          docker pull gitea.jimmylab.duckdns.org/jimmy/runner:latest

          # Use the input container name
          CONTAINER_NAME="on-demand-${{ github.event.inputs.container_name }}"
          echo "ðŸ“ Container name: $CONTAINER_NAME"

          # Start the runner container (no config file needed - all via env vars)
          echo "ðŸš€ Starting runner container..."
          docker run -d \
            --name "$CONTAINER_NAME" \
            --restart=always \
            --network gitea_gitea-network \
            -e GITEA_INSTANCE_URL="http://server:3000/" \
            -e GITEA_RUNNER_REGISTRATION_TOKEN="${{ secrets.RUNNER_TOKEN }}" \
            -e GITEA_RUNNER_NAME="on-demand-runner" \
            -e GITEA_RUNNER_LABELS="on-demand" \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v ~/.ssh/home_server:/root/.ssh/home_server:ro \
            gitea.jimmylab.duckdns.org/jimmy/runner:latest

          echo "â³ Waiting for runner to initialize..."
          sleep 15

          # Verify runner is running
          if docker ps | grep -q "$CONTAINER_NAME"; then
            echo "âœ… Runner container is running"

            # Check logs for connection status
            if docker logs "$CONTAINER_NAME" 2>&1 | grep -q "Connect to Gitea"; then
              echo "âœ… Runner successfully connected to Gitea!"
            else
              echo "âš ï¸  Runner is running but may not be connected yet"
              echo "ðŸ“‹ Recent logs:"
              docker logs --tail 20 "$CONTAINER_NAME"
            fi
          else
            echo "âŒ Runner container failed to start"
            echo "ðŸ“‹ Error logs:"
            docker logs "$CONTAINER_NAME" 2>/dev/null || echo "No logs available"
            exit 1
          fi

          echo ""
          echo "ðŸŽ‰ Runner provisioning completed!"
          echo "ðŸ“Š Container status:"
          docker ps | grep "$CONTAINER_NAME"
          EOF
